<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Home</title>

  <!-- CSS chung -->
  <link rel="stylesheet" href="/css/main.css">

  <!-- Aurora Background -->
  <script type="module" src="/js/aurora.js" defer></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- STYLE RI√äNG CHO TRANG THI·∫æT B·ªä -->
  <style>
    .device-page {
      max-width: 1100px;
      margin: 110px auto 70px;
      padding: 20px 40px 40px;
      border-radius: 26px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 0 40px rgba(0,0,0,0.5), inset 0 0 25px rgba(255,255,255,0.04);
      backdrop-filter: blur(22px);
      text-align: center;
    }

    .device-page-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.2rem;
      margin-bottom: 35px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      background: linear-gradient(90deg,#4efaff,#6b5bff,#7cff67);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 18px rgba(120,255,243,0.7);
    }

    .device-cards {
      display: flex;
      justify-content: center;
      gap: 28px;
      flex-wrap: wrap;
      margin-bottom: 32px;
    }

    .device-card {
      min-width: 260px;
      max-width: 300px;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.24), rgba(255,255,255,0.03));
      border-radius: 22px;
      padding: 22px 20px 18px;
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: 0 0 26px rgba(0,0,0,0.4);
      backdrop-filter: blur(16px);
      transition: 0.25s;
    }

    .device-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 0 32px rgba(107,91,255,0.55);
    }

    .device-card h3 {
      font-size: 1.1rem;
      margin-bottom: 12px;
    }

    .device-actions {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    .device-actions .btn {
      padding: 7px 18px;
      border-radius: 18px;
      font-size: 0.9rem;
    }

    /* H√†ng n√∫t d∆∞·ªõi */
    .device-bottom-actions {
      display: flex;
      justify-content: center;
      gap: 18px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .device-bottom-actions .btn {
      border-radius: 999px;
      padding: 10px 30px;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .btn-panel {
      border: 2px solid #fff;
      background: transparent;
      color: #fff;
    }
    .btn-panel:hover {
      background: #fff;
      color: #000;
    }

    /* MODAL GLASS */
    .modal-overlay,
    .delete-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.6);
      z-index: 5000;
    }

    .modal,
    .delete-modal {
      background: rgba(255,255,255,0.10);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.3);
      backdrop-filter: blur(18px);
      padding: 22px 24px 18px;
      width: 320px;
      text-align: left;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
      animation: fadeIn 0.35s ease-out;
    }

    .modal h3,
    .delete-modal h3 {
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    .modal input,
    .modal select {
      width: 100%;
      margin-top: 6px;
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.4);
      background: rgba(3,10,30,0.8);
      color: #fff;
      padding: 8px 10px;
      outline: none;
      font-size: 0.9rem;
    }

    .modal input::placeholder {
      color: rgba(220,220,220,0.7);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 12px;
    }

    .btn-danger {
      background: linear-gradient(90deg,#ff4d6a,#ff9966);
      border: none;
      color: #fff;
    }
    .btn-danger:hover {
      box-shadow: 0 0 22px rgba(255,120,150,0.8);
    }

    @media (max-width: 768px) {
      .device-page {
        margin: 100px 16px 50px;
        padding: 20px;
      }
    }
  </style>
</head>

<body>
  <div id="aurora-bg" class="aurora-bg"></div>

  <!-- HEADER d√πng chung trong main.css -->
  <header class="header">
    <div class="header-left">
      <h1 class="brand-title">Smart Home</h1>
    </div>

    <nav class="auth-right">
      <% if (user) { %>
        <div class="user-info">
          <span>Xin ch√†o, <strong><%= user.fullName %></strong></span>
          <a href="/auth/logout" class="btn btn-outline">ƒêƒÉng xu·∫•t</a>
        </div>
      <% } else { %>
        <a href="/auth/login" class="btn btn-outline">ƒêƒÉng nh·∫≠p</a>
        <a href="/auth/register" class="btn btn-primary">ƒêƒÉng k√Ω</a>
      <% } %>
    </nav>
  </header>

  <main class="device-page">
    <% if (user) { %>
      <h2 class="device-page-title">Thi·∫øt b·ªã iot</h2>

      <section class="device-grid">
        <div id="device-container" class="device-cards"></div>

        <div class="device-bottom-actions">
          <button id="add-device-btn" class="btn btn-primary">‚ûï Th√™m thi·∫øt b·ªã</button>
          <a href="/panel" class="btn btn-panel">üü¢ Panel ƒëi·ªÅu khi·ªÉn</a>
        </div>
      </section>
    <% } else { %>
      <section class="intro">
        <h2>Ch√†o m·ª´ng ƒë·∫øn v·ªõi h·ªá th·ªëng Smart Home</h2>
        <p>H√£y ƒëƒÉng nh·∫≠p ƒë·ªÉ gi√°m s√°t v√† ƒëi·ªÅu khi·ªÉn c√°c thi·∫øt b·ªã c·ªßa b·∫°n.</p>
      </section>
    <% } %>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <p>&copy; 2025 Smart Home System. All rights reserved.</p>
  </footer>

  <!-- POPUP TH√äM THI·∫æT B·ªä -->
  <div id="deviceModal" class="modal-overlay">
    <div class="modal">
      <h3>‚ûï Th√™m thi·∫øt b·ªã m·ªõi</h3>
      <label for="deviceName">T√™n thi·∫øt b·ªã</label>
      <input type="text" id="deviceName" placeholder="Nh·∫≠p t√™n thi·∫øt b·ªã..." required>

      <label for="deviceType">Lo·∫°i thi·∫øt b·ªã</label>
      <select id="deviceType">
        <option value="1">üå°Ô∏èüíß C·∫£m bi·∫øn </option>
        <option value="2">üåÄ Qu·∫°t</option>
        <option value="3">üí° ƒê√®n</option>
      </select>

      <div class="modal-actions">
        <button id="saveDevice" class="btn btn-primary">L∆∞u</button>
        <button id="closeModal" class="btn btn-outline">H·ªßy</button>
      </div>
    </div>
  </div>

  <!-- POPUP X√ìA THI·∫æT B·ªä -->
  <div id="deleteModal" class="delete-modal-overlay">
    <div class="delete-modal">
      <h3>‚ö†Ô∏è X√°c nh·∫≠n x√≥a</h3>
      <p>B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a thi·∫øt b·ªã n√†y kh√¥ng?</p>
      <div class="modal-actions">
        <button id="confirmDelete" class="btn btn-danger">X√≥a</button>
        <button id="cancelDelete" class="btn btn-outline">H·ªßy</button>
      </div>
    </div>
  </div>

  <% if (user) { %>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const container    = document.getElementById("device-container");
      const modal        = document.getElementById("deviceModal");
      const deleteModal  = document.getElementById("deleteModal");

      const addBtn       = document.getElementById("add-device-btn");
      const saveBtn      = document.getElementById("saveDevice");
      const closeBtn     = document.getElementById("closeModal");

      const nameInput    = document.getElementById("deviceName");
      const typeSelect   = document.getElementById("deviceType");

      let deviceToDelete = null;

      // Load devices
      try {
        const res = await fetch("/api/sensors/user-devices");
        const devices = await res.json();

        if (!devices.length) {
          container.innerHTML = `<p style="color:#ccc;">B·∫°n ch∆∞a c√≥ thi·∫øt b·ªã n√†o.</p>`;
        } else {
          devices.forEach(dev => {
            const icons  = { 1: "üå°Ô∏èüíß", 2: "üåÄ", 3: "üí°" };
            const colors = { 1: "#7cff67", 2: "#6b5bff", 3: "#ffd54f" };

            const card  = document.createElement("div");
            card.className = "device-card";
            card.style.borderColor = colors[dev.DeviceType] + "55";

            const actions = dev.DeviceType == 1
              ? `<a href="/dashboard" class="btn btn-outline">Xem d·ªØ li·ªáu</a>`
              : `<button class="btn btn-primary">ƒêi·ªÅu khi·ªÉn</button>`;

            card.innerHTML = `
              <h3>${icons[dev.DeviceType]} ${dev.Name}</h3>
              <div class="device-actions">
                ${actions}
                <button class="btn btn-outline btn-delete" data-id="${dev.DeviceID}">üóëÔ∏è X√≥a</button>
              </div>
            `;

            container.appendChild(card);
          });
        }
      } catch (err) {
        console.error("L·ªói t·∫£i thi·∫øt b·ªã:", err);
      }

      // Open add modal
      addBtn.addEventListener("click", () => {
        modal.style.display = "flex";
        nameInput.value = "";
        typeSelect.value = "1";
      });

      // Close add modal
      closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
      });

      // Save device
      saveBtn.addEventListener("click", async () => {
        const name = nameInput.value.trim();
        const type = Number(typeSelect.value);
        if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n thi·∫øt b·ªã!");

        try {
          const res = await fetch("/api/sensors/add-device", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, type })
          });

          if (res.ok) {
            modal.style.display = "none";
            location.reload();
          } else {
            alert("Kh√¥ng th·ªÉ th√™m thi·∫øt b·ªã");
          }
        } catch (err) {
          console.error("L·ªói th√™m thi·∫øt b·ªã:", err);
        }
      });

      // Delete click
      container.addEventListener("click", e => {
        if (e.target.classList.contains("btn-delete")) {
          deviceToDelete = e.target.dataset.id;
          deleteModal.style.display = "flex";
        }
      });

      // Cancel delete
      document.getElementById("cancelDelete").addEventListener("click", () => {
        deleteModal.style.display = "none";
      });

      // Confirm delete
      document.getElementById("confirmDelete").addEventListener("click", async () => {
        if (!deviceToDelete) return;

        try {
          const res = await fetch(`/api/sensors/delete-device/${deviceToDelete}`, {
            method: "DELETE"
          });

          if (res.ok) {
            deleteModal.style.display = "none";
            location.reload();
          } else {
            alert("Kh√¥ng th·ªÉ x√≥a thi·∫øt b·ªã!");
          }
        } catch (err) {
          console.error("L·ªói x√≥a thi·∫øt b·ªã:", err);
        }
      });
    });
  </script>
  <% } %>

</body>
</html>
