<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>L·ªãch s·ª≠ d·ªØ li·ªáu c·∫£m bi·∫øn</title>

  <!-- CSS ch√≠nh -->
  <link rel="stylesheet" href="/css/main.css" />

  <!-- Aurora n·ªÅn -->
  <script type="module" src="/js/aurora.js" defer></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>
  <!-- N·ªÅn Aurora -->
  <div id="aurora-bg" class="aurora-bg"></div>

  <!-- N√∫t v·ªÅ dashboard -->
  <a href="/dashboard" class="btn-home">üè† Trang ch·ªß</a>

  <main class="main-content">
    <div class="glass history-box">

      <!-- Ti√™u ƒë·ªÅ -->
      <h2 class="history-title">
        <span class="history-icon"></span>
        L·ªäCH S·ª¨ D·ªÆ LI·ªÜU C·∫¢M BI·∫æN
      </h2>

      <!-- D√≤ng filter -->
      <div class="history-filter-row">
        <div class="history-filter-item">
          <label for="fromDate">T·ª´ ng√†y</label>
          <input type="date" id="fromDate" />
        </div>

        <div class="history-filter-item">
          <label for="toDate">ƒê·∫øn ng√†y</label>
          <input type="date" id="toDate" />
        </div>

        <div class="history-filter-item">
          <label for="typeFilter">Lo·∫°i d·ªØ li·ªáu</label>
          <select id="typeFilter">
            <option value="">T·∫•t c·∫£ lo·∫°i</option>
            <option value="Temperature">Temperature</option>
            <option value="Humidity">Humidity</option>
            <option value="PM2.5">PM2.5</option>
          </select>
        </div>

        <div class="history-filter-item">
          <label for="deviceFilter">Thi·∫øt b·ªã</label>
          <input type="text" id="deviceFilter" placeholder="T√™n thi·∫øt b·ªã" />
        </div>

        <div class="history-filter-actions">
          <button id="filterBtn" class="btn btn-primary">L·ªçc</button>
          <button id="exportBtn" class="btn btn-outline">‚¨á Export CSV</button>
        </div>
      </div>

      <!-- B·∫£ng l·ªãch s·ª≠ -->
      <div class="history-table-wrapper">
        <table class="history-table">
          <thead>
            <tr>
              <th>Th·ªùi gian</th>
              <th>Thi·∫øt b·ªã</th>
              <th>Lo·∫°i</th>
              <th>Gi√° tr·ªã</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr>
              <td colspan="4" class="history-loading">ƒêang t·∫£i...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Ph√¢n trang -->
      <div class="history-pagination">
        <div class="history-page-label">
          Trang <span id="pageInfo">1</span>
        </div>

        <div class="history-page-buttons">
          <button id="prevPage" class="btn btn-outline history-page-btn">¬´ Tr∆∞·ªõc</button>
          <button id="nextPage" class="btn btn-outline history-page-btn">Sau ¬ª</button>
        </div>

        <div class="history-page-size">
          <select id="pageSize">
            <option value="10">10 d√≤ng</option>
            <option value="20" selected>20 d√≤ng</option>
            <option value="50">50 d√≤ng</option>
          </select>
        </div>
      </div>
    </div>
  </main>

  <script>
    let currentPage = 1;

    async function loadHistory() {
      const pageSize = document.getElementById('pageSize').value;
      const type = document.getElementById('typeFilter').value;
      const device = document.getElementById('deviceFilter').value.trim();
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;

      const params = new URLSearchParams({
        page: currentPage,
        pageSize,
        type,
        device,
        from,
        to
      });

      // ƒê∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi ‚Üí /api/sensors/api/history
      const res = await fetch('api/history?' + params.toString());
      const data = await res.json().catch(() => null);

      const body = document.getElementById('historyBody');
      body.innerHTML = '';

      if (!data || !data.rows || !data.rows.length) {
        body.innerHTML = `<tr><td colspan="4" class="history-empty">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
        document.getElementById('pageInfo').innerText = `1/1`;
        document.getElementById('prevPage').disabled = true;
        document.getElementById('nextPage').disabled = true;
        return;
      }

      const { rows, total, page, pageSize: ps } = data;

      rows.forEach(r => {
        body.innerHTML += `
          <tr>
            <td>${new Date(r.Timestamp).toLocaleString("vi-VN")}</td>
            <td>${r.Device}</td>
            <td>${r.Type}</td>
            <td>${r.Value} ${r.Unit || ''}</td>
          </tr>
        `;
      });

      const totalPages = Math.max(1, Math.ceil(total / ps));
      document.getElementById('pageInfo').innerText = `${page}/${totalPages}`;
      document.getElementById('prevPage').disabled = page <= 1;
      document.getElementById('nextPage').disabled = page >= totalPages;
    }

    // S·ª± ki·ªán l·ªçc
    document.getElementById('filterBtn').addEventListener('click', () => {
      currentPage = 1;
      loadHistory();
    });

    // Ph√¢n trang
    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        loadHistory();
      }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
      currentPage++;
      loadHistory();
    });

    document.getElementById('pageSize').addEventListener('change', () => {
      currentPage = 1;
      loadHistory();
    });

    // Export CSV (theo filter hi·ªán t·∫°i)
    document.getElementById('exportBtn').addEventListener('click', () => {
      const type = document.getElementById('typeFilter').value;
      const device = document.getElementById('deviceFilter').value.trim();
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;

      const params = new URLSearchParams({ type, device, from, to });
      window.location.href = 'api/history/export?' + params.toString();
    });

    // Load l·∫ßn ƒë·∫ßu
    loadHistory();
  </script>
</body>
</html>
